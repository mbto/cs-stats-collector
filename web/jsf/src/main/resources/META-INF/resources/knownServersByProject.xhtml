<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html
        PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
<f:metadata>
    <f:viewAction action="#{viewKnownServersByProjectId.fetch()}" onPostback="false" immediate="true"/>
    <p:importEnum type="ru.csdm.stats.webapp.PojoStatus" var="PojoStatus"/>
</f:metadata>

<ui:composition template="../template/layout.xhtml">
<ui:define name="head">
<style type="text/css">
.propToRemove {
    background-color: #ffa6a6 !important;
    background-image: none !important;
    color: #000000 !important;
}
</style>
</ui:define>

<ui:define name="center">
<p:messages id="fetchMsgs" showSummary="true" showDetail="true" rendered="#{empty viewKnownServersByProjectId.selectedProject}"/>
<ui:fragment rendered="#{not empty viewKnownServersByProjectId.selectedProject}">
<p:panel id="edKnServsPanel" header="[#{viewKnownServersByProjectId.selectedProject.id}] #{viewKnownServersByProjectId.selectedProject.name}">
<p:button value="Edit project" outcome="/editProject" icon="ui-icon-arrowthick-1-w">
    <f:param name="projectId" value="#{viewKnownServersByProjectId.selectedProject.id}"/>
</p:button>

<p:separator/>
<h:form id="edKnServsForm">
    <p:dataTable id="knServs" widgetVar="knServsW" value="#{viewKnownServersByProjectId.currentInstanceRows}" var="row"
                 editable="true" emptyMessage="No known servers found" rowIndexVar="rowIndexVar"
                 rowStyleClass="#{row.status == PojoStatus.TO_REMOVE ? 'propToRemove' : null}"
                 styleClass="ui-fluid">
        <f:facet name="header">
            Known servers: #{viewKnownServersByProjectId.currentInstanceRows.size()} |
            Current instance: [#{instanceHolder.currentInstanceId}] #{instanceHolder.availableInstances.get(instanceHolder.currentInstanceId).name}
        </f:facet>
        <p:ajax event="rowEdit" partialSubmit="true" listener="#{viewKnownServersByProjectId.onRowEdit}" update="edKnServsForm:addKnownServerBtn msgs" />
        <p:ajax event="rowEditCancel" partialSubmit="true"/>

        <p:column headerText="ip:port" width="200">
            <p:cellEditor>
                <f:facet name="output"><h:outputText value="#{row.pojo.ipport}"/></f:facet>
                <f:facet name="input"><p:inputText value="#{row.pojo.ipport}" required="true" label="ip:port" placeholder="127.0.0.1:27015"
                                                   validator="#{viewKnownServersByProjectId.validate}" maxlength="21" onkeypress="if(event.keyCode == 13) { return false; }">
                    <f:attribute name="rowIndexVar" value="#{rowIndexVar}"/>
                </p:inputText>
                </f:facet>
            </p:cellEditor>
        </p:column>

        <p:column headerText="Name" width="100%">
            <p:cellEditor>
                <f:facet name="output"><h:outputText value="#{row.pojo.name}"/></f:facet>
                <f:facet name="input"><p:inputText value="#{row.pojo.name}" required="true" label="Name" maxlength="31" onkeypress="if(event.keyCode == 13) { return false; }"/></f:facet>
            </p:cellEditor>
        </p:column>

        <p:column headerText="Active" width="60">
            <p:cellEditor>
                <f:facet name="output"><h:outputText value="#{row.pojo.active ? 'Yes' : 'No'}" rendered="#{not empty row.pojo.active}"/></f:facet>
                <f:facet name="input"><p:selectBooleanButton value="#{row.pojo.active}" onLabel="Yes" offLabel="No" required="true"/></f:facet>
            </p:cellEditor>
        </p:column>

        <p:column headerText="FFA" width="60">
            <p:cellEditor>
                <f:facet name="output"><h:outputText value="#{row.pojo.ffa ? 'Yes' : 'No'}" rendered="#{not empty row.pojo.ffa}"/></f:facet>
                <f:facet name="input"><p:selectBooleanButton value="#{row.pojo.ffa}" onLabel="Yes" offLabel="No" required="true"/></f:facet>
            </p:cellEditor>
        </p:column>

        <p:column headerText="Ignore bots" width="120">
            <p:cellEditor>
                <f:facet name="output"><h:outputText value="#{row.pojo.ignoreBots ? 'Yes' : 'No'}" rendered="#{not empty row.pojo.ignoreBots}"/></f:facet>
                <f:facet name="input"><p:selectBooleanButton value="#{row.pojo.ignoreBots}" onLabel="Yes" offLabel="No" required="true"/></f:facet>
            </p:cellEditor>
        </p:column>

        <p:column headerText="Start session on action" width="120">
            <p:cellEditor rendered="#{row.pojo.instanceId == instanceHolder.currentInstanceId}">
                <f:facet name="output"><h:outputText value="#{row.pojo.startSessionOnAction ? 'Yes' : 'No'}" rendered="#{not empty row.pojo.startSessionOnAction}"/></f:facet>
                <f:facet name="input"><p:selectBooleanButton value="#{row.pojo.startSessionOnAction}" onLabel="Yes" offLabel="No" required="true"/></f:facet>
            </p:cellEditor>
        </p:column>

        <p:column style="width:32px">
            <p:rowEditor />
        </p:column>
        <p:column style="width:8px">
            <ui:fragment rendered="#{row.status == PojoStatus.TO_REMOVE}">
                <p:commandLink value="+" immediate="true" partialSubmit="true" title="Restore"
                               process="@this" update="knServs" style="text-decoration: none;"
                               onstart="PF('buiKnServs').show()" oncomplete="PF('buiKnServs').hide()"
                               actionListener="#{viewKnownServersByProjectId.onRestoreRow(row)}"/>
            </ui:fragment>
            <ui:fragment rendered="#{row.status != PojoStatus.TO_REMOVE}">
                <p:commandLink value="-" immediate="true" partialSubmit="true" title="Remove"
                               process="@this" update="knServs" style="text-decoration: none;"
                               onstart="PF('buiKnServs').show()" oncomplete="PF('buiKnServs').hide()"
                               actionListener="#{viewKnownServersByProjectId.onRemoveRow(row)}"/>
            </ui:fragment>
        </p:column>
    </p:dataTable>
    <p:commandButton id="addKnownServerBtn" value="Add server" immediate="true" partialSubmit="true"
                     process="@this" update="@this knServs" disabled="#{viewKnownServersByProjectId.addServerBtnDisabled}"
                     actionListener="#{viewKnownServersByProjectId.onAddKnownServer()}"
                     icon="ui-icon-plusthick" style="margin: 10px 10px 0 0"/>

    <p:commandButton id="saveBtn" value="Save"
                     process="@this" update="@form msgs"
                     actionListener="#{viewKnownServersByProjectId.save}"
                     icon="ui-icon-check"/>
</h:form>
<p:messages id="msgs" showSummary="true" showDetail="true"/>

<p:separator rendered="#{not empty viewKnownServersByProjectId.selectedProject and not empty viewKnownServersByProjectId.otherInstanceRows}"/>

<ui:repeat value="#{viewKnownServersByProjectId.otherInstanceRows.entrySet()}" var="entry"
           rendered="#{not empty viewKnownServersByProjectId.selectedProject and not empty viewKnownServersByProjectId.otherInstanceRows}">
    <p:dataTable value="#{entry.value}" var="row" style="margin-top:10px;" styleClass="ui-fluid">
        <f:facet name="header">
            Known servers: #{entry.value.size()} |
            Other instance: [#{entry.key}] #{instanceHolder.availableInstances.get(entry.key).name}
        </f:facet>

        <p:column headerText="ip:port" width="200">
            <h:outputText value="#{row.pojo.ipport}"/>
        </p:column>

        <p:column headerText="Name" width="100%">
            <h:outputText value="#{row.pojo.name}"/>
        </p:column>

        <p:column headerText="Active" width="60">
            <h:outputText value="#{row.pojo.active ? 'Yes' : 'No'}" rendered="#{not empty row.pojo.active}"/>
        </p:column>

        <p:column headerText="FFA" width="60">
            <h:outputText value="#{row.pojo.ffa ? 'Yes' : 'No'}" rendered="#{not empty row.pojo.ffa}"/>
        </p:column>

        <p:column headerText="Ignore bots" width="120">
            <h:outputText value="#{row.pojo.ignoreBots ? 'Yes' : 'No'}" rendered="#{not empty row.pojo.ignoreBots}"/>
        </p:column>

        <p:column headerText="Start session on action" width="120">
            <h:outputText value="#{row.pojo.startSessionOnAction ? 'Yes' : 'No'}" rendered="#{not empty row.pojo.startSessionOnAction}"/>
        </p:column>
    </p:dataTable>
</ui:repeat>
</p:panel>
<p:blockUI widgetVar="buiKnServs" block="edKnServsPanel" trigger="edKnServsForm:addKnownServerBtn edKnServsForm:saveBtn edKnServsForm:knServs">
    <p:graphicImage library="images" name="ajaxloadingbar.gif"/>
</p:blockUI>
</ui:fragment>
</ui:define>
</ui:composition>

</html>